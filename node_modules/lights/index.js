var exec = require('child_process').exec;
var parseurl = require('url');

var DEFAULT_PATH = '/lights';
var map = false;
var isItOn=true;

function lights(mapper) {
    map = mapper;
    return lights.express;
}

lights.express = function(req,res,next) {
    if (req.path.indexOf(DEFAULT_PATH) === 0) {
        //replace + and decode
        path = decodeURIComponent(req.path.replace(/\+/g, ' '));
            //remove leading and trailing /
            path = path.replace(/^\/|\/$/g,'');
            //split and remove leading path
            var parts = path.split('/');
            parts.shift();
            var command = parts.shift();
            console.log('executing',command,parts);
            if (lights[command]) {
                if (command === 'start') {
                    lights.start();
                } else {
                lights[command].apply(this,parts);
            }
            //prevent anything else from being served from this subpath
            res.end('executed '+command);
            return;
        }
    }
    next();
};

lights.start = function() {
};

lights.sendKey = function(key) {
    exec('lights.sh ' + key);
};

lights.mapKey = function(command,key,then) {
    lights[command] = function() {
        lights.sendKey(key);
        if (then) {
            then();
        }
    };
};

lights.mapKey('kitchen_on','kitchen on');
lights.mapKey('kitchen_off','kitchen off');
lights.mapKey('living_on','living on');
lights.mapKey('living_off','living off');
lights.mapKey('hall_on','hall on');
lights.mapKey('hall_off','hall off');
lights.mapKey('bedroom_on','bedroom on');
lights.mapKey('bedroom_off','bedroom off');
lights.mapKey('party_on','party on');
lights.mapKey('party_off','party off');
lights.mapKey('bedroom_on','bedroom on');
lights.mapKey('bedroom_off','bedroom off');
lights.mapKey('fan_off','fan off');
lights.mapKey('fan_on','fan on');

module.exports = lights;
