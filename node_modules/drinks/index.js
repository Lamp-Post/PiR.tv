var exec = require('child_process').exec;
var parseurl = require('url');

var DEFAULT_PATH = '/drinks';
var map = false;

function drinks(mapper) {
    map = mapper;
    return drinks.express;
}

drinks.express = function(req,res,next) {
    if (req.path.indexOf(DEFAULT_PATH) === 0) {
        //replace + and decode
        path = decodeURIComponent(req.path.replace(/\+/g, ' '));
            //remove leading and trailing /
            path = path.replace(/^\/|\/$/g,'');
            //split and remove leading path
            var parts = path.split('/');
            parts.shift();
            var command = parts.shift();
            console.log('executing',command,parts);
            if (drinks[command]) {
                if (command === 'start') {
                    drinks.start();
                } else {
                drinks[command].apply(this,parts);
            }
            //prevent anything else from being served from this subpath
            res.end('executed '+command);
            return;
        }
    }
    next();
};

drinks.start = function() {
    cb();

    function cb() {
    }
};

drinks.sendKey = function(key) {
    if ( key == 'textme' ) {
        exec('gvapi -n 17047371123 -m CodeFinished!');
    } else {
        exec('drink_control.sh ' + key);
    }
};

drinks.mapKey = function(command,key,then) {
    drinks[command] = function() {
        drinks.sendKey(key);
        if (then) {
            then();
        }
    };
};

drinks.mapKey('rumcoke','rumcoke');
drinks.mapKey('gintonic','gintonic');
drinks.mapKey('textme','textme');
drinks.mapKey('kill','kill');
module.exports = drinks;
